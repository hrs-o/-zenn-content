---
title: "Unity+MagicOnion4.1.xã‚’è©¦ã™ IL2CPPã§ã‚¹ãƒãƒ›å®Ÿæ©Ÿãƒ“ãƒ«ãƒ‰ç·¨"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["magiconion","grpc","aspnetcore","il2cpp"]
published: true
---

## ãƒãƒ£ãƒ—ã‚¿ãƒ¼

- [ç’°å¢ƒæ§‹ç¯‰&ã‚µãƒ¼ãƒ“ã‚¹ã§ã®é€šä¿¡ç·¨](https://zenn.dev/hrs/articles/magiconion-v4-1-x-unity-service)
- [StreamingHubã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ç·¨](https://zenn.dev/hrs/articles/magiconion-v4-1-x-unity-streaming-hub)
- [ã‚µãƒ¼ãƒãƒ¼ã‚’EC2ç’°å¢ƒã§å‹•ã‹ã™ç·¨](https://zenn.dev/hrs/articles/magiconion-v4-1-x-unity-aws-ec2-nginx)
- [IL2CPPã§ã‚¹ãƒãƒ›å®Ÿæ©Ÿãƒ“ãƒ«ãƒ‰ç·¨](https://zenn.dev/hrs/articles/magiconion-v4-1-x-unity-il2cpp)

## ã¾ãˆãŒã

- [ã‚µãƒ¼ãƒãƒ¼ã‚’EC2ç’°å¢ƒã§å‹•ã‹ã™ç·¨](https://zenn.dev/hrs/articles/magiconion-v4-1-x-unity-aws-ec2-nginx)ã®ç¶šãã«ãªã‚Šã¾ã™
- å®Ÿæ©Ÿãƒ“ãƒ«ãƒ‰ã—ãŸéš›ã«é€šä¿¡çµæœã‚’ã¿ãŸã„ã®ã§AWSãªã©ã‚µãƒ¼ãƒãƒ¼ãŒã‚ã‚‹ã¨ç¢ºèªçš„ã«ã¯ä¾¿åˆ©
- ç’°å¢ƒæ§‹ç¯‰ã€å‰æç­‰ã¯ä¸Šè¨˜ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„
- [READMEè¨˜è¼‰](https://github.com/Cysharp/MagicOnion#magiconion-code-generator-for-il2cpp)ã®ã¨ãŠã‚Šã ã¨MessagePackã®Code GenerateãŒå‹•ã‹ãªã‹ã£ãŸã®ã§ãƒ¡ãƒ¢
- Android / iOSã‚¢ãƒ—ãƒªãã®ã‚‚ã®ã®å®Ÿæ©Ÿãƒ“ãƒ«ãƒ‰ã«é–¢ã™ã‚‹è©³ç´°ã¯è¨˜è¼‰ã—ã¾ã›ã‚“
- iOSã¯å¼·åˆ¶ã§IL2CPP
- Androidã¯PlayerSettingsã‹ã‚‰å¤‰æ›´ã™ã‚‹ã¨IL2CPP

## MyApp-Serverï¼ˆMyApp-Sharedï¼‰ã§MagicOnionã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

### MagicOnion.MSBuild.Tasksã‚’è¿½åŠ 

- NuGetã§MagicOnion.MSBuild.Tasksã‚’MyApp-Sharedã«å¯¾ã—ã¦è¿½åŠ 

![](https://storage.googleapis.com/zenn-user-upload/lin8md9kw1jslhg2t9gdnd0r5yxg)


### MessagePack.MSBuild.Tasksã‚’è¿½åŠ 

- NuGetã§MessagePack.MSBuild.Tasksã‚’MyApp-Sharedã«å¯¾ã—ã¦è¿½åŠ 


![](https://storage.googleapis.com/zenn-user-upload/eopa2i2kjwedyni7gc6qmiiu8tqe)

### MyApp-Shared.csprojã«ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 

:::message
 2021.02.25æ™‚ç‚¹ã§ã¯[READMEè¨˜è¼‰](https://github.com/Cysharp/MagicOnion/blob/489760a/README.md#magiconionmsbuildtasks-msbuild-integration)ã ã¨MessagePackã®è¨˜è¿°ã‚‚è¿½è¨˜ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ãŒã€
 [MessagePackGenerator](https://github.com/neuecc/MessagePack-CSharp/blob/533802a85d517fece47c782aa893af62d942b3e2/src/MessagePack.MSBuild.Tasks/MessagePackGenerator.cs)ã®å¼•æ•°ãŒç•°ãªã£ã¦ãŠã‚Šã€ãã®ã¾ã¾ã ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§çœã„ã¦ã„ã¾ã™
:::

```diff
  <ItemGroup>
    <Compile Include="..\MyApp-Client\Assets\Scripts\MyApp\Shared\**\*.cs" />
  </ItemGroup>

+ <Target Name="GenerateMagicOnion" AfterTargets="Compile">
+  <MagicOnionGenerator Input=".\MyApp-Shared.csproj" Output="..\MyApp-Client\Assets\Scripts\MyApp\Generated\MagicOnion.Generated.cs" />
+ </Target>
```

ã“ã®çŠ¶æ…‹ã§MyApp-Serverã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨`MyApp-Client\Assets\Scripts\MyApp\Generated\MagicOnion.Generated.cs`ãŒç”Ÿæˆã•ã‚Œã‚‹

## Unityã§MessagePackã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

:::message
æœ¬å½“ã¯MagicOnionåŒæ§˜ãƒ“ãƒ«ãƒ‰ã§è‡ªå‹•å‡ºåŠ›ã—ã¦ã»ã—ã„ã€ä»Šãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®ã‚„ã‚Šã‹ãŸçŸ¥ã£ã¦ã‚‹æ–¹ã„ã‚Œã°æ•™ãˆã¦ä¸‹ã•ã„ã€‚
:::

### ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰GUIã‚’ä½¿ã£ã¦ç”Ÿæˆ

- Window > MessagePack > CodeGenerator 

![](https://storage.googleapis.com/zenn-user-upload/jn5694xenrdlq6brda81adzbgw69)

é …ç›® | å€¤
--- | ---
input path | Scripts/MyApp/Shared/MessagePackObjects
output path | Scripts/MyApp/Generated

![](https://storage.googleapis.com/zenn-user-upload/p89bjkganh3g196wj9ceop008vom)

- Generateã‚’æŠ¼ã—ã¦æˆåŠŸã—ãŸã‚ã¨ã€ä¸€åº¦Unityã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‹ã‚‰æˆ»ã‚‹ã¨Unityä¸Šã§èªè­˜ã™ã‚‹
- `\Assets\Scripts\MyApp\Generated\MessagePack_Formatters_MyApp_Shared_MessagePackObjects_PlayerFormat.cs`

### ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£


- ä»Šå›ã¯ç”Ÿæˆå…ƒã§Vector3ãªã©ã‚’ä½¿ã£ã¦ã„ã‚‹ãŒã€ç”Ÿæˆå¾Œã« `using UnityEngine;`ãŒç„¡ãã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã„ã‚‹ã®ã§è¿½åŠ ã—ã¦ã‚ã’ã‚‹

```diff:\Assets\Scripts\MyApp\Generated\MessagePack_Formatters_MyApp_Shared_MessagePackObjects_PlayerFormat.cs
 // <auto-generated>
 // THIS (.cs) FILE IS GENERATED BY MPC(MessagePack-CSharp). DO NOT CHANGE IT.
 // </auto-generated>

+ using UnityEngine;
```

:::message
ã“ã“ã€ã“ã‚“ãªæ³¥è‡­ã„äº‹ã™ã‚‹ã®ã‹ï¼Ÿã®æ°—æŒã¡ã‚ã‚‹ã®ã§è‰¯ã„æ–¹æ³•ã‚¢ãƒ¬ã°æ•™ãˆã¦ã»ã—ã„ã§ã™
ãã‚Œã£ã½ã„[Issues](https://github.com/neuecc/MessagePack-CSharp/issues/1013)ãŒå­˜åœ¨ã™ã‚‹ã®ã§ä¿®æ­£å¾…ã¡ã‹ã‚‚ï¼Ÿ
:::

### Resolverã‚’èª­ã¿è¾¼ã‚€ã‚ˆã†ã«ã™ã‚‹

```cs:Assets\Scripts\MyApp\InitialSettings.cs
using MessagePack;
using MessagePack.Resolvers;
using UnityEngine;

namespace MyApp
{
    class InitialSettings
    {
        [RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]
        static void RegisterResolvers()
        {
            // NOTE: Currently, CompositeResolver doesn't work on Unity IL2CPP build. Use StaticCompositeResolver instead of it.
            StaticCompositeResolver.Instance.Register(
                // This resolver is generated by MagicOnion's code generator.
                MagicOnion.Resolvers.MagicOnionResolver.Instance,
                // This resolver is generated by MessagePack's code generator.
                MessagePack.Resolvers.GeneratedResolver.Instance,
                StandardResolver.Instance
            );

            MessagePackSerializer.DefaultOptions = MessagePackSerializer.DefaultOptions
                .WithResolver(StaticCompositeResolver.Instance);
        }
    }
}
```

### iOSç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ 

- READMEã®ã¾ã¾ã ã¨å‹•ã‹ãªã„ç®‡æ‰€ãŒã‚ã‚‹ã®ã§ä¸€éƒ¨ä¿®æ­£

```diff
+        var targetGuid = project.GetUnityFrameworkTargetGuid();
-        var targetGuid = project.TargetGuidByName(PBXProject.GetUnityTargetName());
```

```cs:Assets\Editor\BuildIos.cs
#if UNITY_IPHONE
using System.IO;
using UnityEngine;
using UnityEditor;
using UnityEditor.Callbacks;
using UnityEditor.iOS.Xcode;

public class BuildIos
{
    /// <summary>
    /// Handle libgrpc project settings.
    /// </summary>
    /// <param name="target"></param>
    /// <param name="path"></param>
    [PostProcessBuild(1)]
    public static void OnPostProcessBuild(BuildTarget target, string path)
    {
        var projectPath = PBXProject.GetPBXProjectPath(path);
        var project = new PBXProject();
        project.ReadFromString(File.ReadAllText(projectPath));
        var targetGuid = project.TargetGuidByName(PBXProject.GetUnityTargetName());

        // libz.tbd for grpc ios build
        project.AddFrameworkToProject(targetGuid, "libz.tbd", false);

        // libgrpc_csharp_ext missing bitcode. as BITCODE exand binary size to 250MB.
        project.SetBuildProperty(targetGuid, "ENABLE_BITCODE", "NO");
        
        File.WriteAllText(projectPath, project.WriteToString());
    }
}
#endif
```

## å„OSã§ãƒ“ãƒ«ãƒ‰

- ç‰¹ç­†äº‹é …ã¯ãªã—ã€SwitchPlatformã—ã¦ãƒ“ãƒ«ãƒ‰
- Androidãªã‚‰apkåãã®ã§USBã§ã‚¹ãƒãƒ›ã«é€ã‚‹ã ã‘
- iOSã¯Xcodeã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒåã‹ã‚Œã‚‹ã®ã§ã€Macã«æŒã£ã¦ã„ããªã‚Šã—ã¦æ›´ã«ãƒ“ãƒ«ãƒ‰
- [ã‚µãƒ¼ãƒãƒ¼ã‚’EC2ç’°å¢ƒã§å‹•ã‹ã™ç·¨](https://zenn.dev/hrs/articles/magiconion-v4-1-x-unity-aws-ec2-nginx)ã®ç’°å¢ƒãŒç”Ÿãã¦ã„ã‚Œã°ã€é€šä¿¡ã®ç¢ºèªãŒã§ãã‚‹ã¯ãšï¼